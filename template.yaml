AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31

# https://docs.aws.amazon.com/lambda/latest/dg/urls-tutorial.html


Resources:
  MotivationBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: decision-dice-motivators

  MotivationBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: decision-dice-motivators
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          Sid: AllowCloudFrontServicePrincipalReadOnly
          Effect: Allow
          Principal:
            Service: cloudfront.amazonaws.com
          Action: 
            - s3:GetObject
          Resource: "arn:aws:s3:::decision-dice-motivators/*"
          Condition:
            StringEquals:
              AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${MotivationDistribution}"

  MotivationOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl  
    Properties:
      OriginAccessControlConfig:
        Name: MotivationOAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4
      
  MotivationDistribution:
    Type: AWS::CloudFront::Distribution  
    Properties:
      DistributionConfig:
        DefaultCacheBehavior:
          TargetOriginId: Motivators
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: !Ref MotivationCachePolicy
        Enabled: true
        Origins:
          - Id: Motivators
            OriginPath: /motivators
            DomainName: decision-dice-motivators.s3.eu-west-2.amazonaws.com
            S3OriginConfig:
              OriginAccessIdentity: ""
            OriginAccessControlId: !Ref MotivationOriginAccessControl

  MotivationCachePolicy:
    Type: AWS::CloudFront::CachePolicy  
    Properties:
      CachePolicyConfig:
        DefaultTTL: 86400
        MaxTTL: 86400
        MinTTL: 86400
        Name: MotivationCachePolicy
        ParametersInCacheKeyAndForwardedToOrigin:
          CookiesConfig:
            CookieBehavior: none
          EnableAcceptEncodingGzip: true
          HeadersConfig:
            HeaderBehavior: none
          QueryStringsConfig:
            QueryStringBehavior: none